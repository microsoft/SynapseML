<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/SynapseML/blog/rss.xml" title="SynapseML RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/SynapseML/blog/atom.xml" title="SynapseML Atom Feed">
<link rel="alternate" type="application/json" href="/SynapseML/blog/feed.json" title="SynapseML JSON Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RWPE0183E8"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RWPE0183E8",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="SynapseML" href="/SynapseML/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">IsolationForest - Multivariate Anomaly Detection | SynapseML</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://microsoft.github.io/SynapseML/img/synapseml_og.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://microsoft.github.io/SynapseML/img/synapseml_og.jpg"><meta data-react-helmet="true" property="og:url" content="https://microsoft.github.io/SynapseML/docs/next/features/isolation_forest/IsolationForest - Multivariate Anomaly Detection/"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="IsolationForest - Multivariate Anomaly Detection | SynapseML"><meta data-react-helmet="true" name="description" content="This recipe shows how you can use SynapseML on Apache Spark for multivariate anomaly detection. Multivariate anomaly detection allows for the detection of anomalies among many variables or timeseries, taking into account all the inter-correlations and dependencies between the different variables. In this scenario, we use SynapseML to train an Isolation Forest model for multivariate anomaly detection, and we then use to the trained model to infer multivariate anomalies within a dataset containing synthetic measurements from three IoT sensors."><meta data-react-helmet="true" property="og:description" content="This recipe shows how you can use SynapseML on Apache Spark for multivariate anomaly detection. Multivariate anomaly detection allows for the detection of anomalies among many variables or timeseries, taking into account all the inter-correlations and dependencies between the different variables. In this scenario, we use SynapseML to train an Isolation Forest model for multivariate anomaly detection, and we then use to the trained model to infer multivariate anomalies within a dataset containing synthetic measurements from three IoT sensors."><link data-react-helmet="true" rel="icon" href="/SynapseML/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://microsoft.github.io/SynapseML/docs/next/features/isolation_forest/IsolationForest - Multivariate Anomaly Detection/"><link data-react-helmet="true" rel="alternate" href="https://microsoft.github.io/SynapseML/docs/next/features/isolation_forest/IsolationForest - Multivariate Anomaly Detection/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://microsoft.github.io/SynapseML/docs/next/features/isolation_forest/IsolationForest - Multivariate Anomaly Detection/" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://GBW8AA15RD-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/SynapseML/assets/css/styles.074bcd8f.css">
<link rel="preload" href="/SynapseML/assets/js/runtime~main.bfaa11b8.js" as="script">
<link rel="preload" href="/SynapseML/assets/js/main.45317aa7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">‚≠êÔ∏è If you like SynapseML, consider giving it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/Microsoft/SynapseML">GitHub</a> ‚≠ê</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/SynapseML/"><div class="navbar__logo"><img src="/SynapseML/img/logo.svg" alt="SynapseML Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/SynapseML/img/logo.svg" alt="SynapseML Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">SynapseML</b></a><a class="navbar__item navbar__link" href="/SynapseML/docs/about/">Docs</a><a class="navbar__item navbar__link" href="/SynapseML/blog/">Blog</a><a class="navbar__item navbar__link" href="/SynapseML/videos/">Videos</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/SynapseML/docs/next/about/">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/SynapseML/docs/next/features/isolation_forest/IsolationForest - Multivariate Anomaly Detection/">Next</a></li><li><a class="dropdown__link" href="/SynapseML/docs/about/">0.9.5</a></li><li><a class="dropdown__link" href="/SynapseML/docs/0.9.4/about/">0.9.4</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_3vod"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/SynapseML/docs/next/features/isolation_forest/IsolationForest - Multivariate Anomaly Detection/" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">Developer Docs</a><ul class="dropdown__menu"><li><a href="https://mmlspark.blob.core.windows.net/docs/0.9.5/pyspark/index.html" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Python<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li><a href="https://mmlspark.blob.core.windows.net/docs/0.9.5/scala/com/microsoft/azure/synapse/ml/index.html" target="_blank" rel="noopener noreferrer" class="dropdown__link"><span>Scala<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><a href="https://github.com/microsoft/SynapseML" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_71bT toggle_3Zt9 toggleChecked_2FvV toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">üåú</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">üåû</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" checked="" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Kl_"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/SynapseML/docs/next/about/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/SynapseML/docs/next/getting_started/installation/">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_2fq0" href="/SynapseML/docs/next/features/cognitive_services/CognitiveServices - Analyze Text/">Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/cognitive_services/CognitiveServices - Analyze Text/">Cognitive Services</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/isolation_forest/IsolationForest - Multivariate Anomaly Detection/">Isolation Forest</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/SynapseML/docs/next/features/isolation_forest/IsolationForest - Multivariate Anomaly Detection/">IsolationForest - Multivariate Anomaly Detection</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/geospatial_services/GeospatialServices - Flooding Risk/">Geospatial Services</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/responsible_ai/Data Balance Analysis/">Responsible AI</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/onnx/ONNX - Inference on Spark/">ONNX</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/lightgbm/LightGBM - Overview/">LightGBM</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/vw/Vowpal Wabbit - Overview/">Vowpal Wabbit</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/spark_serving/SparkServing - Deploying a Classifier/">Spark Serving</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/opencv/OpenCV - Pipeline Image Transformations/">OpenCV</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/classification/Classification - Adult Census with Vowpal Wabbit/">Classification</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/regression/Regression - Auto Imports/">Regression</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" tabindex="0" href="/SynapseML/docs/next/features/other/AzureSearchIndex - Met Artworks/">Other</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/SynapseML/docs/next/documentation/transformers/transformers_cognitive/">Transformers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/SynapseML/docs/next/documentation/estimators/estimators_cognitive/">Estimators</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/SynapseML/docs/next/mlflow/introduction/">MLflow</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_2fq0" href="/SynapseML/docs/next/reference/developer-readme/">Reference</a></div></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->SynapseML<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/SynapseML/docs/about/">latest version</a></b> (<!-- -->0.9.5<!-- -->).</div></div><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->Next</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Recipe: Multivariate Anomaly Detection with Isolation Forest</h1></header><p>This recipe shows how you can use SynapseML on Apache Spark for multivariate anomaly detection. Multivariate anomaly detection allows for the detection of anomalies among many variables or timeseries, taking into account all the inter-correlations and dependencies between the different variables. In this scenario, we use SynapseML to train an Isolation Forest model for multivariate anomaly detection, and we then use to the trained model to infer multivariate anomalies within a dataset containing synthetic measurements from three IoT sensors.</p><p>To learn more about the Isolation Forest model please refer to the original paper by <a href="https://cs.nju.edu.cn/zhouzh/zhouzh.files/publication/icdm08b.pdf?q=isolation-forest" target="_blank" rel="noopener noreferrer">Liu <em>et al.</em></a>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="library-imports">Library imports<a class="hash-link" href="#library-imports" title="Direct link to heading">‚Äã</a></h2><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token keyword">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> uuid</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> mlflow</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> matplotlib</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">pyplot </span><span class="token keyword">as</span><span class="token plain"> plt</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">from</span><span class="token plain"> pyspark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">sql </span><span class="token keyword">import</span><span class="token plain"> functions </span><span class="token keyword">as</span><span class="token plain"> F</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">from</span><span class="token plain"> pyspark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">ml</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">feature </span><span class="token keyword">import</span><span class="token plain"> VectorAssembler</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">from</span><span class="token plain"> pyspark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">sql</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">types </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">from</span><span class="token plain"> pyspark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">ml </span><span class="token keyword">import</span><span class="token plain"> Pipeline</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">from</span><span class="token plain"> synapse</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">ml</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">isolationforest </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">from</span><span class="token plain"> synapse</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">ml</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">explainers </span><span class="token keyword">import</span><span class="token plain"> </span><span class="token operator">*</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token operator">%</span><span class="token plain">matplotlib inline</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">if</span><span class="token plain"> os</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;AZURE_SERVICE&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> </span><span class="token boolean">None</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;Microsoft.ProjectArcadia&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword">from</span><span class="token plain"> pyspark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">sql </span><span class="token keyword">import</span><span class="token plain"> SparkSession</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    spark </span><span class="token operator">=</span><span class="token plain"> SparkSession</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">builder</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">getOrCreate</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="input-data">Input data<a class="hash-link" href="#input-data" title="Direct link to heading">‚Äã</a></h2><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># Table inputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">timestampColumn </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;timestamp&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(136, 132, 111)"># str: the name of the timestamp column in the table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">inputCols </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor_1&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor_2&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor_3&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token plain"> </span><span class="token comment" style="color:rgb(136, 132, 111)"># list(str): the names of the input variables </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:rgb(136, 132, 111)"># Training Start time, and number of days to use for training: </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">trainingStartTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;2022-02-24T06:00:00Z&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(136, 132, 111)"># datetime: datetime for when to start the training</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">trainingEndTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;2022-03-08T23:55:00Z&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(136, 132, 111)"># datetime: datetime for when to end the training</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">inferenceStartTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;2022-03-09T09:30:00Z&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(136, 132, 111)"># datetime: datetime for when to start the training</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">inferenceEndTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;2022-03-20T23:55:00Z&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(136, 132, 111)"># datetime: datetime for when to end the training</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:rgb(136, 132, 111)"># Isolation Forest parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">contamination </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(174, 129, 255)">0.021</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">num_estimators </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(174, 129, 255)">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">max_samples </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(174, 129, 255)">256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">max_features </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(174, 129, 255)">1.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:rgb(136, 132, 111)"># MLFlow experiment</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">artifact_path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;isolationforest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">experiment_name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(230, 219, 116)">f&quot;/Shared/isolation_forest_experiment-</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(174, 129, 255)">str</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string-interpolation interpolation">uuid</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token string-interpolation interpolation">uuid1</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">}</span><span class="token string-interpolation string" style="color:rgb(230, 219, 116)">/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">model_name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;isolation-forest-model&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">model_version </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(174, 129, 255)">1</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="read-data">Read data<a class="hash-link" href="#read-data" title="Direct link to heading">‚Äã</a></h2><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">df </span><span class="token operator">=</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">read</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">format</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;csv&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">option</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;header&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;true&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;wasbs://publicwasb@mmlspark.blob.core.windows.net/generated_sample_mvad_data.csv&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>cast columns to appropriate data types</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">df </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    df</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">orderBy</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;timestamp&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">date_format</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;yyyy-MM-dd&#x27;T&#x27;HH:mm:ss&#x27;Z&#x27;&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_1&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_1&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">cast</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">DoubleType</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_2&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_2&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">cast</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">DoubleType</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_3&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_3&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">cast</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">DoubleType</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">drop</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;_c5&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">display</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">df</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="training-data-preparation">Training data preparation<a class="hash-link" href="#training-data-preparation" title="Direct link to heading">‚Äã</a></h2><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># filter to data with timestamps within the training window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">df_train </span><span class="token operator">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">filter</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> trainingStartTime</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"> </span><span class="token operator">&lt;=</span><span class="token plain"> trainingEndTime</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">display</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">df_train</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="test-data-preparation">Test data preparation<a class="hash-link" href="#test-data-preparation" title="Direct link to heading">‚Äã</a></h2><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># filter to data with timestamps within the inference window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">df_test </span><span class="token operator">=</span><span class="token plain"> df</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">filter</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> inferenceStartTime</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"> </span><span class="token operator">&lt;=</span><span class="token plain"> inferenceEndTime</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">display</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">df_test</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="train-isolation-forest-model">Train Isolation Forest model<a class="hash-link" href="#train-isolation-forest-model" title="Direct link to heading">‚Äã</a></h2><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">isolationForest </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">IsolationForest</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setNumEstimators</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">num_estimators</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setBootstrap</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setMaxSamples</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">max_samples</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setMaxFeatures</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">max_features</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setFeaturesCol</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;features&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setPredictionCol</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;predictedLabel&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setScoreCol</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;outlierScore&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setContamination</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">contamination</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setContaminationError</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">0.01</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> contamination</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">setRandomSeed</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">1</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Next, we create an ML pipeline to train the Isolation Forest model. We also demonstrate how to create an MLFlow experiement and register the trained model.</p><p>Note that MLFlow model registration is strictly only required if accessing the trained model at a later time. For training the model, and performing inferencing in the same notebook, the model object model is sufficient.</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">mlflow</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">set_experiment</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">experiment_name</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">with</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">start_run</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    va </span><span class="token operator">=</span><span class="token plain"> VectorAssembler</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">inputCols</span><span class="token operator">=</span><span class="token plain">inputCols</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> outputCol</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;features&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    pipeline </span><span class="token operator">=</span><span class="token plain"> Pipeline</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">stages</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">va</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> isolationForest</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    model </span><span class="token operator">=</span><span class="token plain"> pipeline</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">fit</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">df_train</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    mlflow</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">spark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">log_model</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> artifact_path</span><span class="token operator">=</span><span class="token plain">artifact_path</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">registered_model_name</span><span class="token operator">=</span><span class="token plain">model_name</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="perform-inferencing">Perform inferencing<a class="hash-link" href="#perform-inferencing" title="Direct link to heading">‚Äã</a></h2><p>Load the trained Isolation Forest Model</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">model_uri </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:rgb(230, 219, 116)">f&quot;models:/</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">{</span><span class="token string-interpolation interpolation">model_name</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">}</span><span class="token string-interpolation string" style="color:rgb(230, 219, 116)">/</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">{</span><span class="token string-interpolation interpolation">model_version</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(249, 38, 114)">}</span><span class="token string-interpolation string" style="color:rgb(230, 219, 116)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">model </span><span class="token operator">=</span><span class="token plain"> mlflow</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">spark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">load_model</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">model_uri</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Perform inferencing</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">df_test_pred </span><span class="token operator">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">df_test</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">display</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">df_test_pred</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="ml-interpretability">ML interpretability<a class="hash-link" href="#ml-interpretability" title="Direct link to heading">‚Äã</a></h2><p>In this section, we use ML interpretability tools to help unpack the contribution of each sensor to the detected anomalies at any point in time.</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># Here, we create a TabularSHAP explainer, set the input columns to all the features the model takes, specify the model and the target output column </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:rgb(136, 132, 111)"># we are trying to explain. In this case, we are trying to explain the &quot;outlierScore&quot; output.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">shap </span><span class="token operator">=</span><span class="token plain"> TabularSHAP</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    inputCols</span><span class="token operator">=</span><span class="token plain">inputCols</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    outputCol</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;shapValues&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    model</span><span class="token operator">=</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    targetCol</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;outlierScore&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    backgroundData</span><span class="token operator">=</span><span class="token plain">F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">broadcast</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">df_test</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Display the dataframe with <code>shapValues</code> column</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">shap_df </span><span class="token operator">=</span><span class="token plain"> shap</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">df_test_pred</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">display</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">shap_df</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># Define UDF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">vec2array </span><span class="token operator">=</span><span class="token plain"> udf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token keyword">lambda</span><span class="token plain"> vec</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"> vec</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">toArray</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ArrayType</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">FloatType</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># Here, we extract the SHAP values, the original features and the outlier score column. Then we convert it to a Pandas DataFrame for visualization. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:rgb(136, 132, 111)"># For each observation, the first element in the SHAP values vector is the base value (the mean output of the background dataset), </span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:rgb(136, 132, 111)"># and each of the following elements represents the SHAP values for each feature</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">shaps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    shap_df</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;shapValues&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> vec2array</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;shapValues&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">getItem</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">0</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">select</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;shapValues&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;outlierScore&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> inputCols </span><span class="token operator">+</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(230, 219, 116)">&quot;prediction&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_1_localimp&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;shapValues&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token number" style="color:rgb(174, 129, 255)">1</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_2_localimp&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;shapValues&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token number" style="color:rgb(174, 129, 255)">2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">withColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_3_localimp&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> F</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">col</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;shapValues&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token number" style="color:rgb(174, 129, 255)">3</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">shaps_local </span><span class="token operator">=</span><span class="token plain"> shaps</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">toPandas</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">shaps_local</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Retrieve local feature importances</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">local_importance_values </span><span class="token operator">=</span><span class="token plain"> shaps_local</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;shapValues&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">eval_data </span><span class="token operator">=</span><span class="token plain"> shaps_local</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">inputCols</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># Removing the first element in the list of local importance values (this is the base value or mean output of the background dataset)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">list_local_importance_values </span><span class="token operator">=</span><span class="token plain"> local_importance_values</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">values</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">converted_importance_values </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">bias </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">for</span><span class="token plain"> classarray </span><span class="token keyword">in</span><span class="token plain"> list_local_importance_values</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword">for</span><span class="token plain"> rowarray </span><span class="token keyword">in</span><span class="token plain"> classarray</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        converted_list </span><span class="token operator">=</span><span class="token plain"> rowarray</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        bias</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">converted_list</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token number" style="color:rgb(174, 129, 255)">0</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:rgb(136, 132, 111)"># remove the bias from local importance values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword">del</span><span class="token plain"> converted_list</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token number" style="color:rgb(174, 129, 255)">0</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        converted_importance_values</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">converted_list</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Next, install libraries required for ML Interpretability analysis</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">!pip install </span><span class="token operator">-</span><span class="token operator">-</span><span class="token plain">upgrade raiwidgets</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">!pip install </span><span class="token operator">-</span><span class="token operator">-</span><span class="token plain">upgrade interpret</span><span class="token operator">-</span><span class="token plain">community</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token keyword">from</span><span class="token plain"> interpret_community</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">adapter </span><span class="token keyword">import</span><span class="token plain"> ExplanationAdapter</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">adapter </span><span class="token operator">=</span><span class="token plain"> ExplanationAdapter</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">inputCols</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> classification</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">global_explanation </span><span class="token operator">=</span><span class="token plain"> adapter</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">create_global</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">converted_importance_values</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> eval_data</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> expected_values</span><span class="token operator">=</span><span class="token plain">bias</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># view the global importance values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">global_explanation</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">global_importance_values</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># view the local importance values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">global_explanation</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">local_importance_values</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># Defining a wrapper class with predict method for creating the Explanation Dashboard</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">wrapper</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token builtin" style="color:rgb(174, 129, 255)">object</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(166, 226, 46)">__init__</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">model </span><span class="token operator">=</span><span class="token plain"> model</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(166, 226, 46)">predict</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        sparkdata </span><span class="token operator">=</span><span class="token plain"> spark</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">createDataFrame</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword">return</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">transform</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">sparkdata</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">select</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;outlierScore&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">toPandas</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">values</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">flatten</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tolist</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="visualize-results">Visualize results<a class="hash-link" href="#visualize-results" title="Direct link to heading">‚Äã</a></h2><p>Visualize anomaly results and feature contribution scores (derived from local feature importance)</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token keyword">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(166, 226, 46)">visualize</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    anoms </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(174, 129, 255)">list</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;prediction&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(174, 129, 255)">1</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    fig </span><span class="token operator">=</span><span class="token plain"> plt</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">figure</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">figsize</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">26</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token number" style="color:rgb(174, 129, 255)">12</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax </span><span class="token operator">=</span><span class="token plain"> fig</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">add_subplot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">611</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">title</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">set_text</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string-interpolation string" style="color:rgb(230, 219, 116)">f&quot;Multivariate Anomaly Detection Results&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_1&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:orange&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linestyle</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;solid&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linewidth</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_1&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">grid</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;y&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    _</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymin</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymax </span><span class="token operator">=</span><span class="token plain"> plt</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">axis</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">vlines</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">anoms</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymin</span><span class="token operator">=</span><span class="token plain">ymin </span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymax</span><span class="token operator">=</span><span class="token plain">ymax </span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:red&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> alpha</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">0.2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linewidth</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">6</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tick_params</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;x&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">which</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;both&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">bottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">labelbottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">set_ylabel</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor1_value&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">legend</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax </span><span class="token operator">=</span><span class="token plain"> fig</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">add_subplot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">612</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> sharex</span><span class="token operator">=</span><span class="token plain">ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_2&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:green&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linestyle</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;solid&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linewidth</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_2&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">grid</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;y&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    _</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymin</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymax </span><span class="token operator">=</span><span class="token plain"> plt</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">axis</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">vlines</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">anoms</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymin</span><span class="token operator">=</span><span class="token plain">ymin </span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymax</span><span class="token operator">=</span><span class="token plain">ymax </span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:red&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> alpha</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">0.2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linewidth</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">6</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tick_params</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;x&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">which</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;both&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">bottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">labelbottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">set_ylabel</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor2_value&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">legend</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax </span><span class="token operator">=</span><span class="token plain"> fig</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">add_subplot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">613</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> sharex</span><span class="token operator">=</span><span class="token plain">ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_3&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:purple&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linestyle</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;solid&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linewidth</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_3&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">grid</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;y&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    _</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymin</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymax </span><span class="token operator">=</span><span class="token plain"> plt</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">axis</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">vlines</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">anoms</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymin</span><span class="token operator">=</span><span class="token plain">ymin </span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> ymax</span><span class="token operator">=</span><span class="token plain">ymax </span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:red&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> alpha</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">0.2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linewidth</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">6</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tick_params</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;x&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">which</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;both&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">bottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">labelbottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">set_ylabel</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor3_value&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">legend</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax </span><span class="token operator">=</span><span class="token plain"> fig</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">add_subplot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">614</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> sharex</span><span class="token operator">=</span><span class="token plain">ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tick_params</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;x&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">which</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;both&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">bottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">labelbottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;outlierScore&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;black&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linestyle</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;solid&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> linewidth</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;Outlier score&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">set_ylabel</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;outlier score&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">grid</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;y&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">legend</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax </span><span class="token operator">=</span><span class="token plain"> fig</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">add_subplot</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">615</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> sharex</span><span class="token operator">=</span><span class="token plain">ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">tick_params</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;x&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">which</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;both&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">bottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">labelbottom</span><span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">bar</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor_1_localimp&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">abs</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> width</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:orange&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_1&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">bar</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor_2_localimp&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">abs</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> width</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:green&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_2&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> bottom</span><span class="token operator">=</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_1_localimp&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">abs</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">bar</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token plain">timestampColumn</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;sensor_3_localimp&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">abs</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> width</span><span class="token operator">=</span><span class="token number" style="color:rgb(174, 129, 255)">2</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> color</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;tab:purple&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> label</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_3&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> bottom</span><span class="token operator">=</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_1_localimp&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">abs</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token operator">+</span><span class="token plain">rdf</span><span class="token punctuation" style="color:rgb(249, 38, 114)">[</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;sensor_2_localimp&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">]</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token builtin" style="color:rgb(174, 129, 255)">abs</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">set_ylabel</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;Contribution scores&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">grid</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">axis</span><span class="token operator">=</span><span class="token string" style="color:rgb(230, 219, 116)">&#x27;y&#x27;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    ax</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">legend</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">    plt</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">show</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">visualize</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">shaps_local</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When you run the cell above, you will see the following plots:</p><p><img src="https://mmlspark.blob.core.windows.net/graphics/notebooks/mvad_results_local_importances.jpg"></p><ul><li>The first 3 plots above show the sensor time series data in the inference window, in orange, green, purple and blue. The red vertical lines show the detected anomalies (<code>prediction</code> = 1).. </li><li>The fourth plot shows the outlierScore of all the points, with the <code>minOutlierScore</code> threshold shown by the dotted red horizontal line</li><li>The last plot shows the contribution scores of each sensor to the <code>outlierScore</code> for that point.</li></ul><p>Plot aggregate feature importance</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token plain">plt</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">figure</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">figsize</span><span class="token operator">=</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token number" style="color:rgb(174, 129, 255)">10</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token number" style="color:rgb(174, 129, 255)">7</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">plt</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">bar</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">inputCols</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> global_explanation</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">global_importance_values</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">plt</span><span class="token punctuation" style="color:rgb(249, 38, 114)">.</span><span class="token plain">ylabel</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token string" style="color:rgb(230, 219, 116)">&quot;global importance values&quot;</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When you run the cell above, you will see the following global feature importance plot:</p><p><img src="https://mmlspark.blob.core.windows.net/graphics/notebooks/global_feature_importance.jpg"></p><p>Visualize the explanation in the ExplanationDashboard from <a href="https://github.com/microsoft/responsible-ai-widgets" target="_blank" rel="noopener noreferrer">https://github.com/microsoft/responsible-ai-widgets</a>.</p><div class="codeBlockContainer_K1bP language-python theme-code-block"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#f8f8f2;background-color:#272822"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:rgb(136, 132, 111)"># View the model explanation in the ExplanationDashboard</span><span class="token plain"></span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword">from</span><span class="token plain"> raiwidgets </span><span class="token keyword">import</span><span class="token plain"> ExplanationDashboard</span><br></span><span class="token-line" style="color:#f8f8f2"><span class="token plain">ExplanationDashboard</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">global_explanation</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> wrapper</span><span class="token punctuation" style="color:rgb(249, 38, 114)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><span class="token punctuation" style="color:rgb(249, 38, 114)">,</span><span class="token plain"> dataset</span><span class="token operator">=</span><span class="token plain">eval_data</span><span class="token punctuation" style="color:rgb(249, 38, 114)">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/SynapseML/docs/next/features/cognitive_services/CognitiveServices - Predictive Maintenance/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">CognitiveServices - Predictive Maintenance</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/SynapseML/docs/next/features/geospatial_services/GeospatialServices - Flooding Risk/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">GeospatialServices - Flooding Risk</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#library-imports" class="table-of-contents__link toc-highlight">Library imports</a></li><li><a href="#input-data" class="table-of-contents__link toc-highlight">Input data</a></li><li><a href="#read-data" class="table-of-contents__link toc-highlight">Read data</a></li><li><a href="#training-data-preparation" class="table-of-contents__link toc-highlight">Training data preparation</a></li><li><a href="#test-data-preparation" class="table-of-contents__link toc-highlight">Test data preparation</a></li><li><a href="#train-isolation-forest-model" class="table-of-contents__link toc-highlight">Train Isolation Forest model</a></li><li><a href="#perform-inferencing" class="table-of-contents__link toc-highlight">Perform inferencing</a></li><li><a href="#ml-interpretability" class="table-of-contents__link toc-highlight">ML interpretability</a></li><li><a href="#visualize-results" class="table-of-contents__link toc-highlight">Visualize results</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/SynapseML/docs/getting_started/installation/">Installation</a></li><li class="footer__item"><a class="footer__link-item" href="/SynapseML/docs/getting_started/first_example/">Getting Started</a></li><li class="footer__item"><a href="https://mmlspark.blob.core.windows.net/docs/0.9.5/pyspark/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Python API Reference</a></li><li class="footer__item"><a href="https://mmlspark.blob.core.windows.net/docs/0.9.5/scala/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Scala API Reference</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/SynapseML/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/SynapseML/videos/">Videos</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/microsoft/SynapseML" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 Microsoft.</div></div></div></footer></div>
<script src="/SynapseML/assets/js/runtime~main.bfaa11b8.js"></script>
<script src="/SynapseML/assets/js/main.45317aa7.js"></script>
</body>
</html>