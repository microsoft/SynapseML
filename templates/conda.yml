steps:
  - bash: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH
    retryCountOnTaskFailure: 1
  - bash: sudo chown -R $(whoami):$(id -ng) $(CONDA_CACHE_DIR)
    displayName: Fix directory permissions
  - task: Cache@2
    displayName: Use cached Anaconda environment
    inputs:
      key: 'conda | "$(Agent.OS)" | environment.yml'
      restoreKeys: |
        python | "$(Agent.OS)"
        python
      path: $(CONDA_CACHE_DIR)
      cacheHitVar: CONDA_CACHE_RESTORED
    timeoutInMinutes: 20
    retryCountOnTaskFailure: 1
  - bash: |
      echo "=== Checking sizes of unused pre-installed SDKs ==="
      if [ -d /usr/local/lib/android ]; then
        echo "Android SDK:"
        du --max-depth=0 -h /usr/local/lib/android 2>/dev/null || echo "  (size check failed)"
      else
        echo "Android SDK: not found"
      fi
      echo ""
      echo "=== Disk space BEFORE cleanup ==="
      df -h / | grep -E 'Filesystem|/$'
      echo ""
      echo "Removing unused pre-installed SDKs..."
      sudo rm -rf /usr/local/lib/android || true
      echo ""
      echo "=== Disk space AFTER cleanup ==="
      df -h / | grep -E 'Filesystem|/$'
    displayName: 'Free disk space (remove unused SDKs)'
    condition: eq(variables['CONDA_CACHE_RESTORED'], 'false')
  - bash: |
      set -e
      df -H
      (timeout 30m conda env create --yes -f environment.yml -v)  || (timeout 30m conda env create --yes -f environment.yml -v)
      conda clean --all -y
      pip cache purge
    displayName: Create Anaconda environment
    retryCountOnTaskFailure: 1
    condition: eq(variables.CONDA_CACHE_RESTORED, 'false')
  - bash: |
      df -H
    displayName: Check space
    condition: always()